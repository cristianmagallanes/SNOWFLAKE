

CREATE OR REPLACE PROCEDURE DB_ODIN.SH_STAGING.SP_COPY_TABLE_CSV_INIT_END("P_DATABASE" VARCHAR(16777216), "P_SCHEMA" VARCHAR(16777216), "P_DS_LOAD_PROCESS_NAME" VARCHAR(16777216), "P_TABLE_TARGET" VARCHAR(16777216), "P_TABLE_SOURCE" VARCHAR(16777216),  "P_INC" NUMBER(1,0) DEFAULT 0 , "P_PATTERN" VARCHAR(16777216) DEFAULT '', "P_COMPRESSION" VARCHAR(16777216) DEFAULT 'AUTO', "P_TRUNCATECOLUMNS" BOOLEAN DEFAULT FALSE, "P_RECORD_DELIMITER" VARCHAR(16777216) DEFAULT '', "P_FIELD_DELIMITER" VARCHAR(16777216) DEFAULT '', "P_PARSE_HEADER" BOOLEAN DEFAULT FALSE, "P_SKIP_HEADER" NUMBER(38,0) DEFAULT 1, "P_ON_ERROR" VARCHAR(16777216) DEFAULT 'continue')
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'declare

    V_SQL_QUERY VARCHAR(5000);
    V_SQL_QUERY_TEST VARCHAR(5000);
    V_COMPRESSION VARCHAR(100);
    V_RECORD_DELIMITER VARCHAR(100);
    V_SQL_RESPONSE VARCHAR(5000);
    V_AUX string;

    V_PROCESS_ID string;
    V_PROCESS_ID_LOG string;
    V_ERROR integer;
    V_ERROR_MSG string;

begin

    V_ERROR := 0;--
    V_SQL_QUERY := '''';
    --V_PROCESS_ID := (SELECT ID_LOAD_PROCESS FROM DB_METADATA.SH_MAIN.D_DWH_LOAD_PROCESS WHERE DS_LOAD_PROCESS_NAME = :P_DS_LOAD_PROCESS_NAME);
    --V_PROCESS_ID_LOG := (CALL DB_METADATA.SH_MAIN.SP_INIT_METADATA_LOG (:P_DS_LOAD_PROCESS_NAME));

    ---Asignacion de parametros de entrada a variables
   
    IF (P_DATABASE IS NULL OR P_DATABASE = '''') THEN
        V_ERROR := 1;
    ELSE
        V_SQL_QUERY := ''COPY INTO '' || P_DATABASE || V_SQL_QUERY;
    END IF;
    
    IF (P_SCHEMA IS NULL OR P_SCHEMA = '''') THEN
        V_ERROR := 1;
    ELSE
        V_SQL_QUERY := V_SQL_QUERY || ''.'' || P_SCHEMA;
    END IF;

    IF (P_TABLE_TARGET IS NULL OR P_TABLE_TARGET = '''') THEN
        V_ERROR := 1;
    ELSE
        V_SQL_QUERY := V_SQL_QUERY || ''.'' || P_TABLE_TARGET;
    END IF;
 
    IF (P_TABLE_SOURCE IS NULL OR P_TABLE_SOURCE = '''') THEN
        V_ERROR := 1;
    ELSE
        V_SQL_QUERY := V_SQL_QUERY || '' FROM '''''' ||     P_TABLE_SOURCE  || ''''''''  ;
    END IF;

    IF (P_TRUNCATECOLUMNS IS NULL) THEN
        V_ERROR := 1;
    ELSE
        V_SQL_QUERY := V_SQL_QUERY || ''\\n TRUNCATECOLUMNS = '' || P_TRUNCATECOLUMNS ;
    END IF;

    ----OPCIONES DEL FILE FORMAT
    IF (P_COMPRESSION IS NULL OR P_COMPRESSION = '''') THEN
        V_ERROR := V_SQL_QUERY || '' FILE_FORMAT = ( TYPE = CSV ,      NULL_IF = (''''-'''', '''''''') COMPRESSION = AUTO '';
    ELSE
        V_SQL_QUERY := V_SQL_QUERY || '' FILE_FORMAT = ( TYPE = CSV,   NULL_IF = (''''-'''', '''''''' ) COMPRESSION = '' || P_COMPRESSION || '''';
    END IF;

    V_SQL_QUERY := V_SQL_QUERY || '' FIELD_OPTIONALLY_ENCLOSED_BY=''''"'''' '';

    V_SQL_QUERY := V_SQL_QUERY || '' error_on_column_count_mismatch=false '';

        ----OPCIONES DEL FILE FORMAT
    IF (P_RECORD_DELIMITER IS NOT NULL AND P_RECORD_DELIMITER <> '''') THEN
        V_SQL_QUERY :=V_SQL_QUERY || '' RECORD_DELIMITER = '''''' || P_RECORD_DELIMITER || '''';
    END IF;

    IF (P_FIELD_DELIMITER IS NOT NULL AND P_FIELD_DELIMITER <> '''') THEN
        V_SQL_QUERY :=V_SQL_QUERY || '' FIELD_DELIMITER = '''''' || P_FIELD_DELIMITER || '''''''';
    END IF;

    IF (P_PARSE_HEADER IS NOT NULL AND P_PARSE_HEADER = TRUE) THEN
        V_SQL_QUERY :=V_SQL_QUERY || '' MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE PARSE_HEADER = '' || P_PARSE_HEADER || '''';
    END IF;

    IF (P_SKIP_HEADER IS NOT NULL AND (P_PARSE_HEADER IS NULL OR P_PARSE_HEADER = FALSE)) THEN
        V_SQL_QUERY := V_SQL_QUERY || '' SKIP_HEADER = '' || P_SKIP_HEADER;
    END IF;

    V_SQL_QUERY := V_SQL_QUERY || '' )'';
  
    IF (P_PATTERN IS NOT NULL AND P_PATTERN <> '''') THEN
        V_SQL_QUERY := V_SQL_QUERY || '' PATTERN = '''''' || P_PATTERN || '''''''';
    END IF;

    IF (P_ON_ERROR IS NOT NULL AND P_ON_ERROR <> '''') THEN
        V_SQL_QUERY := V_SQL_QUERY || '' ON_ERROR = '''''' || P_ON_ERROR || '''''''';
    END IF;

     IF (:P_INC = 0 and V_ERROR <> 1 ) THEN  
                    EXECUTE IMMEDIATE ''TRUNCATE TABLE '' || P_DATABASE || ''.'' || P_SCHEMA || ''.'' || P_TABLE_TARGET || '';'';
    END IF;


    begin
        EXECUTE IMMEDIATE :V_SQL_QUERY;
    EXCEPTION
      WHEN statement_error OR expression_error THEN
        V_ERROR_MSG := :SQLSTATE || '' - '' || :sqlerrm;
        V_ERROR := 1;
      WHEN OTHER THEN
        V_ERROR_MSG := :SQLSTATE || '' - '' || :sqlerrm;
        V_ERROR := 1;
    end;

    if (V_ERROR = 1)
    then
        CALL DB_METADATA.SH_MAIN.SP_FINISH_METADATA_LOG (:P_DS_LOAD_PROCESS_NAME, :V_PROCESS_ID_LOG, 0, ''ERROR'', :V_ERROR_MSG, ''PROCEDURE EXECUTION'');
    else
        V_AUX := (SELECT TOP 1 $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
    
        if (V_AUX=''Copy executed with 0 files processed.'')
        then
            V_SQL_RESPONSE := ''0'';
        ELSE
            V_SQL_RESPONSE := (SELECT SUM($4) FROM TABLE(RESULT_SCAN(LAST_QUERY_ID(-2))));
        END IF;
        CALL DB_METADATA.SH_MAIN.SP_FINISH_METADATA_LOG (:P_DS_LOAD_PROCESS_NAME, :V_PROCESS_ID_LOG, :V_SQL_RESPONSE, ''SUCCESS'', '''', ''PROCEDURE EXECUTION'');
    END IF;

    RETURN :V_PROCESS_ID_LOG;
    
END';
    