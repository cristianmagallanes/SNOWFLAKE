
CREATE OR REPLACE PROCEDURE DB_WORKDAY.SH_STAGING.SP_UTIL_BACKUP_TABLE(
    DB_NAME STRING,
    SCHEMA_NAME STRING,
    TABLE_NAME STRING,
    OVERWRITE NUMBER DEFAULT 0,
    CLEAN NUMBER DEFAULT 0,
    RETENTION NUMBER DEFAULT 0
)
RETURNS VARCHAR(250)
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
DECLARE
    -- VARIABLES DE ENTORNO
    VAR_TODATE TIMESTAMPLTZ;
    VAR_DB STRING;
    VAR_SCHEMA STRING;
    VAR_TABLE STRING;
    VAR_BACKUP_TABLE_NAME STRING;
    VAR_BKP_PATTERN STRING;
    VAR_SQL_FETCH_TABLES STRING;

BEGIN
    -- 1. INICIAR VARIABLES
    SET VAR_DB := UPPER(:DB_NAME);
    SET VAR_SCHEMA := UPPER(:SCHEMA_NAME);
    SET VAR_TABLE := UPPER(:TABLE_NAME);
    SET VAR_TODATE := CURRENT_TIMESTAMP(2);
    
    SET VAR_BACKUP_TABLE_NAME := 'BKP_' || :VAR_TABLE || '_' || TO_VARCHAR(:VAR_TODATE, 'YYYYMMDD');

    -- 2. CREAR BACKUP
    IF (:OVERWRITE = 1) THEN
        EXECUTE IMMEDIATE
            'CREATE OR REPLACE TABLE ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_BACKUP_TABLE_NAME ||
            ' AS SELECT * FROM ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_TABLE || ';';
    ELSE
        EXECUTE IMMEDIATE
            'CREATE TABLE IF NOT EXISTS ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_BACKUP_TABLE_NAME ||
            ' AS SELECT * FROM ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_TABLE || ';';
    END IF;

    -- 3. LIMPIEZA 
    IF (:CLEAN = 1 AND :RETENTION > 1) THEN
        
        SET VAR_BKP_PATTERN := 'BKP_' || :VAR_TABLE || '_%';
        
        
        VAR_SQL_FETCH_TABLES := 'SELECT TABLE_CATALOG, TABLE_SCHEMA, TABLE_NAME 
                                 FROM ' || :VAR_DB || '.INFORMATION_SCHEMA.TABLES 
                                 WHERE TABLE_TYPE = ''BASE TABLE''
                                   AND TABLE_SCHEMA = ''' || :VAR_SCHEMA || '''
                                   AND TABLE_CATALOG = ''' || :VAR_DB || '''
                                   AND TABLE_NAME ILIKE ''' || :VAR_BKP_PATTERN || '''
                                 QUALIFY ROW_NUMBER() OVER (ORDER BY CREATED DESC) > ' || :RETENTION;

        
        BEGIN
            LET RS_DROP RESULTSET := (EXECUTE IMMEDIATE :VAR_SQL_FETCH_TABLES);
            LET C_DROP CURSOR FOR RS_DROP;
           
            
            FOR R IN C_DROP DO
                LET DROP_CMD STRING := 'DROP TABLE ' || R.TABLE_CATALOG || '.' 
                                                     || R.TABLE_SCHEMA || '.' 
                                                     || R.TABLE_NAME;
                EXECUTE IMMEDIATE :DROP_CMD;
            END FOR;
        END;

    END IF;

    RETURN 'BACKUP TABLE CREATED SUCCESSFULLY';

EXCEPTION
    WHEN OTHER THEN
        RETURN 'ERROR IN SP_UTIL_BACKUP_TABLE: ' || SQLERRM;
END;
$$;


/*


CREATE OR REPLACE PROCEDURE DB_WORKDAY.SH_STAGING.SP_UTIL_BACKUP_TABLE(
    DB_NAME STRING,
    SCHEMA_NAME STRING,
    TABLE_NAME STRING,
    CLEAN NUMBER DEFAULT 0,
    RETENTION NUMBER DEFAULT 0
    
)
RETURNS VARCHAR(250)
LANGUAGE SQL
EXECUTE AS CALLER
AS
$$
DECLARE
    VAR_TODATE TIMESTAMPLTZ;
    VAR_DB STRING;
    VAR_SCHEMA STRING;
    VAR_TABLE STRING;
    VAR_BACKUP_TABLE_NAME STRING;
    VAR_SQL_CLEANUP STRING;
    VAR_BKP_PATTERN STRING;
BEGIN
    -- NORMALIZAR PARAMETROS A MAYUSCULAS
    SET VAR_DB := UPPER(:DB_NAME);
    SET VAR_SCHEMA := UPPER(:SCHEMA_NAME);
    SET VAR_TABLE := UPPER(:TABLE_NAME);

    -- TIMESTAMP PARA SUFIJO (PRECISION DIARIA)
    SET VAR_TODATE := CURRENT_TIMESTAMP(2);

    -- NOMBRE BACKUP: BKP_<TABLA>_YYYYMMDD
    SET VAR_BACKUP_TABLE_NAME := 'BKP_' || :VAR_TABLE || '_' || TO_VARCHAR(:VAR_TODATE, 'YYYYMMDD');

    -- CREAR BACKUP SI NO EXISTE
    EXECUTE IMMEDIATE
        'CREATE TABLE IF NOT EXISTS ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_BACKUP_TABLE_NAME ||
        ' AS SELECT * FROM ' || :VAR_DB || '.' || :VAR_SCHEMA || '.' || :VAR_TABLE || ';';

    -- LIMPIEZA: SOLO SI CLEAN = 1
    IF (:CLEAN = 1 AND :RETENTION > 1) THEN
        SET VAR_BKP_PATTERN := 'BKP_' || :VAR_TABLE || '_%';

        -- 1) EJECUTAR SELECT DINAMICO QUE ARMA EL BLOQUE BEGIN...END CON DROPS (RN > RETENTION)
        EXECUTE IMMEDIATE
        'WITH TO_DROP AS (
            SELECT
                T.TABLE_CATALOG,
                T.TABLE_SCHEMA,
                T.TABLE_NAME,
                ROW_NUMBER() OVER (ORDER BY T.CREATED DESC) AS RN
            FROM ' || :VAR_DB || '.INFORMATION_SCHEMA.TABLES AS T
            WHERE T.TABLE_TYPE = ''BASE TABLE''
              AND T.TABLE_SCHEMA = ''' || :VAR_SCHEMA || '''
              AND T.TABLE_CATALOG = ''' || :VAR_DB || '''
              AND T.TABLE_NAME ILIKE ''' || :VAR_BKP_PATTERN || '''
        )
        SELECT
            CASE
                WHEN COUNT(*) = 0 THEN NULL
                ELSE CONCAT(
                    ''BEGIN '',
                    LISTAGG(''DROP TABLE '' || TABLE_CATALOG || ''.'' || TABLE_SCHEMA || ''.'' || TABLE_NAME || '';'' ) 
                    WITHIN GROUP (ORDER BY RN),
                    '' END'')
            END AS SQL_BLOCK
            FROM TO_DROP
        WHERE RN > ' || TO_VARCHAR(NVL(:RETENTION, 0)) || ';';

        -- 2) CAPTURAR EL RESULTADO DEL SELECT DINAMICO
        SELECT SQL_BLOCK
        INTO :VAR_SQL_CLEANUP
        FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

        -- 3) EJECUTAR EL BLOQUE DE DROPS SI HAY TEXTO
        IF (:VAR_SQL_CLEANUP IS NOT NULL AND LENGTH(:VAR_SQL_CLEANUP) > 0) THEN
            EXECUTE IMMEDIATE :VAR_SQL_CLEANUP;
        END IF;
        
    END IF;

    RETURN 'BACKUP TABLE CREATED SUCCESSFULLY';

    
EXCEPTION
    WHEN OTHER THEN
        RETURN 'ERROR CREATING BACKUP TABLE: ' || SQLERRM;
END;
$$;
*/
